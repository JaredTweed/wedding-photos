<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding Photos Config — Shared Lens</title>
  <meta name="theme-color" content="#000000" />

  <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>

  <!-- Type: elegant serif for wordmark + clean sans for body -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Poppins:wght@400;600&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --ink: #111;
      --paper: #f6f6f6;
      --primary: hsl(96 23.7% 54%);
      /* default to match the sliders' initial values */
      --current-hue: 96;
      --current-sat: 23.7;
      --current-light: 54;
    }

    * {
      box-sizing: border-box;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100svh - 32px);
      padding: 0;

    }

    .card {
      width: 100%;
      max-width: 720px;
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 18px;
      box-shadow: 0 10px 0 #000;
      padding: 2rem clamp(1.25rem, 3vw, 2.5rem);
      text-align: center;
      margin: 8px 8px 16px;
    }

    /* Brand lockup */
    .brand {
      display: grid;
      grid-template-columns: 100%;
      justify-items: center;
      gap: .75rem;
      margin-bottom: .5rem;
    }

    .logo-mark {
      width: 90px;
      height: 90px;
      object-fit: contain;
    }

    .wordmark {
      margin: 0;
      font-family: 'Cormorant Garamond', serif;
      font-weight: 700;
      letter-spacing: 0.18em;
      font-size: clamp(1.4rem, 4.8vw, 2rem);
      text-transform: uppercase;
    }

    .subtitle {
      margin: .25rem 0 0 0;
      font-size: .95rem;
      color: #444;
      font-style: italic;
    }

    /* Divider */
    .rule {
      border: none;
      height: 1px;
      background: #000;
      margin: 1rem auto 1.25rem;
      width: min(620px, 90%);
      opacity: 0.15;
    }

    /* Content text */
    p {
      margin: auto;
      /* max-width: 60ch; */
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-underline-offset: 3px;
    }

    /* Form layout (kept monochrome to match style) */
    form {
      text-align: left;
      margin: 0 auto;
      width: min(640px, 100%);
    }

    .field {
      margin: 1rem 0;
    }

    label {
      display: inline-block;
      font-weight: 600;
      margin-bottom: .35rem;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: .85rem 1rem;
      border-radius: 12px;
      border: 2px solid #000;
      background: #fff;
      font-size: 1rem;
      box-shadow: 0 4px 0 #000;
      outline: none;
      transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease;
    }

    input[type="text"]:focus,
    select:focus {
      transform: translateY(-1px);
    }

    input::placeholder {
      color: #6b7280;
    }

    /* Buttons (identical language to landing page) */
    .button-row {
      display: grid;
      gap: .75rem;
      justify-items: center;
      margin-top: 1.25rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .6rem;
      padding: .85rem 1.4rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 999px;
      border: 2px solid #000;
      cursor: pointer;
      text-decoration: none;
      transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, color .12s ease;
      will-change: transform;
    }

    .btn-fill {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 0 #000;
    }

    .btn-fill:hover {
      transform: translateY(-2px);
      filter: brightness(0.96);
    }

    .btn-fill:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #000;
      filter: brightness(0.9);
    }

    .btn-outline {
      background: #fff;
      color: #111;
      box-shadow: 0 6px 0 #000;
    }

    .btn-outline:hover {
      transform: translateY(-2px);
      background: #f4f4f4;
    }

    .btn-outline:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #000;
      background: #e5e5e5;
    }

    .btn-danger {
      background: #fff5f5;
      color: #991b1b;
      border-color: #991b1b;
      box-shadow: 0 6px 0 #991b1b;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      background: #fee2e2;
    }

    .btn-danger:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #991b1b;
      background: #fecaca;
    }

    /* Color section (kept clean; only tracks are colorful) */
    .color-card {
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 16px;
      box-shadow: 0 6px 0 #000;
      padding: 1.25rem;
      margin: 1rem 0 0.25rem;
    }

    .color-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: .75rem;
    }

    .color-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: .02em;
    }

    #colorPreviewLarge {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 2px solid #000;
      box-shadow: 0 4px 0 #000;
      background: hsl(var(--current-hue), var(--current-sat), var(--current-light));
    }

    .hsl-readout {
      margin: .5rem 0 1rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: .9rem;
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 10px;
      box-shadow: 0 4px 0 #000;
      padding: .5rem .75rem;
      text-align: center;
    }

    .slider-block {
      margin: .8rem 0 1rem;
    }

    .slider-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: .9rem;
    }

    .slider-value {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      border: 1.5px solid #000;
      border-radius: 8px;
      padding: .2rem .5rem;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 28px;
      border-radius: 8px;
      margin-top: .45rem;
      border: 1.5px solid #000;
      background: #eee;
      box-shadow: 0 3px 0 #000;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 0 2px 0 #000;
    }

    input[type="range"]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 0 2px 0 #000;
    }

    /* Colorful tracks */
    .hue-track {
      background: linear-gradient(to right,
          #ff0000 0%,
          #ffff00 17%,
          #00ff00 33%,
          #00ffff 50%,
          #0000ff 67%,
          #ff00ff 83%,
          #ff0000 100%);
    }

    .sat-track {
      background: linear-gradient(to right,
          hsl(var(--current-hue) 0% 50%) 0%,
          hsl(var(--current-hue) 100% 50%) 100%);
    }

    .light-track {
      background: linear-gradient(to right,
          hsl(var(--current-hue) var(--current-sat) 0%) 0%,
          hsl(var(--current-hue) var(--current-sat) 50%) 50%,
          hsl(var(--current-hue) var(--current-sat) 100%) 100%);
    }

    /* Tiny note */
    .notice {
      font-size: .85rem;
      color: #555;
      opacity: .9;
      text-align: center;
    }

    .notice-text {
      margin-bottom: .75rem;
    }

    .notice-actions {
      display: flex;
      flex-wrap: wrap;
      gap: .6rem;
      justify-content: center;
    }

    .notice-actions .btn {
      width: 100%;
    }

    @media (min-width: 560px) {
      .notice-actions .btn {
        width: auto;
        min-width: 160px;
      }
    }

    .danger-zone {
      display: none;
      margin-top: 2rem;
      padding: 1.25rem;
      border: 2px solid #991b1b;
      border-radius: 16px;
      background: #fff8f8;
      text-align: left;
      box-shadow: 0 6px 0 #991b1b22;
    }

    .danger-zone h3 {
      margin: 0 0 .45rem;
      font-size: 1.05rem;
      letter-spacing: .01em;
      color: #7f1d1d;
    }

    .danger-zone p {
      margin: 0 0 .75rem;
      color: #7f1d1d;
      font-size: .9rem;
    }

    .danger-zone .danger-actions {
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    .danger-zone input[type="text"] {
      margin: 0;
      width: 100%;
    }

    @media (min-width: 560px) {
      .danger-zone .danger-actions {
        flex-direction: row;
        align-items: center;
      }

      .danger-zone input[type="text"] {
        flex: 1;
      }

      .danger-zone .btn-danger {
        flex-shrink: 0;
        margin: 0;
      }
    }

    /* User bar (monochrome) */
    #sl-userbar {
      position: fixed;
      top: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10000;
    }

    #sl-user-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 2px solid #000;
      box-shadow: 0 4px 0 #000;
      cursor: pointer;
      background: #eee;
      object-fit: cover;
    }

    #sl-user-menu {
      position: absolute;
      top: 56px;
      right: 0;
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 12px;
      box-shadow: 0 8px 0 #000;
      padding: 6px;
      min-width: 180px;
      display: none;
    }

    #sl-user-menu.show {
      display: block;
    }

    #sl-user-menu button {
      width: 100%;
      background: none;
      border: 0;
      text-align: left;
      padding: .6rem .8rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    #sl-user-menu button:hover {
      background: #111;
      color: #fff;
    }

    @media (max-width: 640px) {
      .card {
        padding: 1.5rem;
      }

      form {
        width: 100%;
      }
    }
  </style>
  <script>
    (function enforceCanonicalFormPath() {
      if (!/^https?:$/i.test(window.location.protocol)) return;
      if (/\/form\.html$/i.test(window.location.pathname)) {
        const query = window.location.search || '';
        const hash = window.location.hash || '';
        window.location.replace('/form' + query + hash);
      }
    })();
  </script>
</head>

<body>
  <!-- User menu -->
  <div id="sl-userbar" style="display:none;">
    <img id="sl-user-avatar" alt="User" />
    <div id="sl-user-menu">
      <button id="sl-main">Go to main page</button>
      <button id="sl-auth">Sign in</button>
    </div>
  </div>

  <main class="card">
    <!-- Brand -->
    <div class="brand">
      <img class="logo-mark" src="/assets/shared-lens-logo.png" alt="Shared Lens logo" />
      <h1 class="wordmark">Shared Lens</h1>
      <p class="subtitle">Different perspectives, one story.</p>
    </div>

    <hr class="rule" />

    <!-- Config form -->
    <form onsubmit="submitForm(event)">
      <p style="text-align:center; margin-top:.25rem">
        Configure your wedding photos site. Your settings can be changed later.
      </p>

      <div class="field">
        <label for="siteTitle">Site Title</label>
        <input id="siteTitle" type="text" placeholder="Wedding Photos" />
      </div>

      <div class="color-card" aria-label="Primary color selector">
        <canvas id="hueGradientCanvas" width="360" height="1" style="display:none;"></canvas>

        <div class="color-head">
          <h3 class="color-title">Primary Color</h3>
          <div id="colorPreviewLarge" title="Preview"></div>
        </div>

        <div id="hslValue" class="hsl-readout">hsl(96 23.7% 54%)</div>

        <div class="slider-block">
          <div class="slider-label">
            <span>Hue</span><span class="slider-value" id="hueValue">96°</span>
          </div>
          <input id="hue" class="hue-track hue" type="range" min="0" max="360" step="1" value="96"
            oninput="updateColor()" />
        </div>

        <div class="slider-block">
          <div class="slider-label">
            <span>Saturation</span><span class="slider-value" id="satValue">23.7%</span>
          </div>
          <input id="sat" class="sat-track" type="range" min="0" max="100" step="0.1" value="23.7"
            oninput="updateColor()" />
        </div>

        <div class="slider-block">
          <div class="slider-label">
            <span>Lightness</span><span class="slider-value" id="lightValue">54%</span>
          </div>
          <input id="light" class="light-track" type="range" min="0" max="100" step="0.1" value="54"
            oninput="updateColor()" />
        </div>
      </div>

      <div class="field">
        <label for="siteFont">Site Font</label>
        <select id="siteFont">
          <option value="serif">Elegant Serif (Crimson Text)</option>
          <option value="sans">Modern Sans (Poppins)</option>
        </select>
      </div>

      <div class="button-row">
        <button type="submit" class="btn btn-fill">Submit</button>
      </div>

      <div id="siteResult" class="notice" style="display:none; margin-top:1rem;"></div>

      <div id="deleteSiteSection" class="danger-zone" aria-live="polite">
        <h3>Delete this site</h3>
        <p id="deleteSiteHelp">This will permanently remove the site and its files. Type "<span id="deleteSitePhrase"></span>" (the saved site title) to confirm.</p>
        <div class="danger-actions">
          <input id="deleteSiteConfirm" type="text" inputmode="text" autocomplete="off" aria-describedby="deleteSiteHelp" placeholder="delete Site Title">
          <button type="button" class="btn btn-danger" id="deleteSiteButton">Delete site permanently</button>
        </div>
      </div>
    </form>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOcPjy9OsoWDuykf0XuvKfB9sAxSRvC7A",
      authDomain: "sharedlens.ca",
      projectId: "wedding-login-32785",
      storageBucket: "wedding-login-32785.firebasestorage.app",
      messagingSenderId: "554454604780",
      appId: "1:554454604780:web:d7dfe10583f26d13cc7ec9",
      measurementId: "G-J9BEKPXHYF"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    const managedConfigPromise = import('/config.js');
    const FONT_OPTIONS = {
      serif: "'Crimson Text', 'Libre Baskerville', serif",
      sans: "'Poppins', 'Segoe UI', sans-serif"
    };
    const DEFAULT_FONT_KEY = 'serif';

    function resolveFontKey(value) {
      if (!value) return DEFAULT_FONT_KEY;
      if (FONT_OPTIONS[value]) return value;
      for (const [key, css] of Object.entries(FONT_OPTIONS)) {
        if (css === value) return key;
      }
      return DEFAULT_FONT_KEY;
    }
    let editingSite = null;
    let deleteConfirmPhrase = '';

    const ensureTrailingSlash = (value) => {
      if (!value) return '';
      return value.endsWith('/') ? value : `${value}/`;
    };
    /* --- dynamic HSL handling --- */
    function hsl() {
      const h = document.getElementById('hue').value;
      const s = document.getElementById('sat').value;
      const l = document.getElementById('light').value;
      return `hsl(${h} ${s}% ${l}%)`;
    }

    function updateColor() {
      const h = document.getElementById('hue').value;
      const s = document.getElementById('sat').value;
      const l = document.getElementById('light').value;
      const color = `hsl(${h} ${s}% ${l}%)`;

      // Update CSS custom properties
      document.documentElement.style.setProperty('--primary', color);
      document.documentElement.style.setProperty('--current-hue', h);
      document.documentElement.style.setProperty('--current-sat', s);

      // Update displays
      document.getElementById('hslValue').textContent = color;
      document.getElementById('colorPreviewLarge').style.background = color;

      // Update individual value displays
      document.getElementById('hueValue').textContent = h + '°';
      document.getElementById('satValue').textContent = s + '%';
      document.getElementById('lightValue').textContent = l + '%';

      // Update slider backgrounds for saturation and lightness
      const satSlider = document.getElementById('sat');
      const lightSlider = document.getElementById('light');

      satSlider.style.background = `linear-gradient(to right, 
        hsl(${h}, 0%, 50%) 0%, 
        hsl(${h}, 100%, 50%) 100%)`;

      lightSlider.style.background = `linear-gradient(to right, 
        hsl(${h}, ${s}%, 0%) 0%, 
        hsl(${h}, ${s}%, 50%) 50%, 
        hsl(${h}, ${s}%, 100%) 100%)`;
    }

    // Initialize color display
    updateColor();




    function generatePerfectHueGradient() {
      const canvas = document.getElementById('hueGradientCanvas');
      const ctx = canvas.getContext('2d');
      const width = canvas.width;

      for (let x = 0; x < width; x++) {
        ctx.fillStyle = `hsl(${x}, 100%, 50%)`;
        ctx.fillRect(x, 0, 1, 1);
      }

      const dataURL = canvas.toDataURL();
      document.querySelector('.hue').style.backgroundImage = `url(${dataURL})`;
      document.querySelector('.hue').style.backgroundSize = '100% 100%';
    }

    generatePerfectHueGradient();

    // Guard range sliders against accidental changes while scrolling on touch devices
    (function installRangeGuards() {
      const sliders = document.querySelectorAll('input[type="range"]');
      const THRESHOLD = 8;

      sliders.forEach(slider => {
        let startX = 0, startY = 0, startValue = slider.value;

        const resetGuard = () => {
          slider.dataset.touchGuard = '';
        };

        slider.addEventListener('pointerdown', e => {
          if (e.pointerType !== 'touch') return;
          startX = e.clientX;
          startY = e.clientY;
          startValue = slider.value;
          slider.dataset.touchGuard = 'pending';
        }, { passive: true });

        slider.addEventListener('pointermove', e => {
          if (e.pointerType !== 'touch') return;
          const guardState = slider.dataset.touchGuard;
          if (!guardState || guardState === 'allowed') return;

          const dx = Math.abs(e.clientX - startX);
          const dy = Math.abs(e.clientY - startY);

          if (guardState === 'pending') {
            if (dy > dx && dy > THRESHOLD) {
              slider.dataset.touchGuard = 'blocked';
              if (slider.value !== startValue) {
                slider.value = startValue;
                if (typeof updateColor === 'function') updateColor();
              }
              slider.blur();
              return;
            }
            if (dx > THRESHOLD) {
              slider.dataset.touchGuard = 'allowed';
            }
          }
        }, { passive: true });

        const cleanup = () => {
          slider.dataset.touchGuard = '';
        };

        slider.addEventListener('pointerup', cleanup, { passive: true });
        slider.addEventListener('pointercancel', cleanup, { passive: true });

        slider.addEventListener('input', () => {
          if (slider.dataset.touchGuard === 'blocked') {
            slider.value = startValue;
            if (typeof updateColor === 'function') updateColor();
          }
        });
      });
    })();

  </script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    // --- Auth readiness helper (fixes the "first submit says not signed in") ---
    // Tiny helper to wait for a definitive auth state
    function waitForUser() {
      const u = firebase.auth().currentUser;
      if (u) return Promise.resolve(u);
      return new Promise(resolve => {
        const off = firebase.auth().onAuthStateChanged(user => { off(); resolve(user || null); });
      });
    }

    const userbar = document.getElementById('sl-userbar');
    const avatarEl = document.getElementById('sl-user-avatar');
    const menuEl = document.getElementById('sl-user-menu');
    const mainBtn = document.getElementById('sl-main');
    const authBtn = document.getElementById('sl-auth');
    const siteResult = document.getElementById('siteResult');
    const siteTitleInput = document.getElementById('siteTitle');
    const deleteSection = document.getElementById('deleteSiteSection');
    const deletePhraseEl = document.getElementById('deleteSitePhrase');
    const deleteInput = document.getElementById('deleteSiteConfirm');
    const deleteButton = document.getElementById('deleteSiteButton');

    const params = new URLSearchParams(window.location.search);
    const rawSlugParam = (params.get('slug') || '').trim().toLowerCase();
    const SLUG_PARAM = /^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(rawSlugParam) ? rawSlugParam : '';

    function showSiteNotice(message) {
      if (!siteResult) return;

      const hasContent = (() => {
        if (typeof message === 'string') return message !== '';
        if (message && typeof message === 'object') {
          const { prefix, linkHref, linkText, suffix, text, afterRender, buttons } = message;
          return Boolean(
            (typeof prefix === 'string' && prefix !== '') ||
            linkHref ||
            (typeof linkText === 'string' && linkText !== '') ||
            (typeof suffix === 'string' && suffix !== '') ||
            (typeof text === 'string' && text !== '') ||
            (Array.isArray(buttons) && buttons.length) ||
            typeof afterRender === 'function'
          );
        }
        return false;
      })();

      if (!hasContent) {
        siteResult.style.display = 'none';
        siteResult.textContent = '';
        siteResult.removeAttribute('data-state');
        return;
      }

      siteResult.innerHTML = '';
      siteResult.style.display = 'block';
      const state = (typeof message === 'object' && message && message.state) ? message.state : 'notice';
      siteResult.dataset.state = state;

      if (typeof message === 'string') {
        siteResult.textContent = message;
        return;
      }

      const { prefix = '', text = '', linkHref = '', linkText = '', suffix = '', buttons = [], afterRender } = message || {};
      const textBlock = document.createElement('div');
      textBlock.className = 'notice-text';

      if (prefix) textBlock.appendChild(document.createTextNode(prefix));
      if (text) textBlock.appendChild(document.createTextNode(text));
      if (linkHref) {
        const anchor = document.createElement('a');
        anchor.href = linkHref;
        anchor.textContent = linkText || linkHref;
        anchor.target = '_blank';
        anchor.rel = 'noopener noreferrer';
        textBlock.appendChild(anchor);
      } else if (linkText) {
        textBlock.appendChild(document.createTextNode(linkText));
      }
      if (suffix) textBlock.appendChild(document.createTextNode(suffix));

      if (textBlock.childNodes.length) {
        siteResult.appendChild(textBlock);
      }

      if (Array.isArray(buttons) && buttons.length) {
        const actions = document.createElement('div');
        actions.className = 'notice-actions';
        buttons.forEach((buttonInfo) => {
          const buttonEl = createNoticeButton(buttonInfo);
          if (buttonEl) actions.appendChild(buttonEl);
        });
        if (actions.childNodes.length) {
          siteResult.appendChild(actions);
        }
      }

      if (typeof afterRender === 'function') afterRender(siteResult);
    }

    function attachQrDownloadHandler(target, slug, siteUrl) {
      if (!target || target.dataset.qrBound === '1') return;
      if (!slug || !siteUrl) return;
      target.dataset.qrBound = '1';
      target.addEventListener('click', async (event) => {
        event.preventDefault();
        const originalText = target.textContent;
        target.textContent = 'Preparing...';
        target.setAttribute('aria-busy', 'true');
        const resetDisabled = 'disabled' in target;
        if (resetDisabled) target.disabled = true;
        try {
          const qrDownloadUrl = `https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=${encodeURIComponent(siteUrl)}`;
          const response = await fetch(qrDownloadUrl);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);
          const downloadLink = document.createElement('a');
          downloadLink.href = objectUrl;
          downloadLink.download = `${slug}-qr.png`;
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
          URL.revokeObjectURL(objectUrl);
        } catch (err) {
          console.error('Failed to download QR code', err);
          alert('Could not download the QR code. Please try again.');
        } finally {
          target.textContent = originalText;
          target.removeAttribute('aria-busy');
          if (resetDisabled) target.disabled = false;
        }
      });
    }

    function createNoticeButton(info) {
      if (!info || !info.label) return null;
      const variant = info.variant || 'btn-outline';
      let element;

      if (info.kind === 'qr-download') {
        element = document.createElement('button');
        element.type = 'button';
        element.className = `btn ${variant}`.trim();
        element.textContent = info.label;
        attachQrDownloadHandler(element, info.slug, info.siteUrl);
        return element;
      }

      if (info.href) {
        element = document.createElement('a');
        element.href = info.href;
        element.textContent = info.label;
        element.className = `btn ${variant}`.trim();
        if (info.target) {
          element.target = info.target;
        } else {
          element.target = '_blank';
        }
        if (info.rel) {
          element.rel = info.rel;
        } else if (element.target === '_blank') {
          element.rel = 'noopener noreferrer';
        }
        return element;
      }

      element = document.createElement('button');
      element.type = 'button';
      element.textContent = info.label;
      element.className = `btn ${variant}`.trim();
      if (typeof info.onClick === 'function') {
        element.addEventListener('click', info.onClick);
      }
      return element;
    }

    function refreshDeleteSection(options = {}) {
      if (!deleteSection) return;
      const hasSite = !!(editingSite && editingSite.slug);
      if (!hasSite) {
        deleteSection.style.display = 'none';
        deleteConfirmPhrase = '';
        if (deletePhraseEl) deletePhraseEl.textContent = '';
        if (deleteInput && options.resetInput !== false) {
          deleteInput.value = '';
          deleteInput.placeholder = 'delete Site Title';
        }
        return;
      }

      const storedTitle = (editingSite.title || '').trim();
      const slug = editingSite.slug || '';
      const targetTitle = storedTitle || slug;
      if (!targetTitle) {
        deleteSection.style.display = 'none';
        return;
      }

      deleteConfirmPhrase = `delete ${targetTitle}`;
      if (deletePhraseEl) deletePhraseEl.textContent = deleteConfirmPhrase;
      if (deleteInput) {
        if (options.resetInput) deleteInput.value = '';
        deleteInput.placeholder = deleteConfirmPhrase;
      }
      deleteSection.style.display = 'block';
    }

    if (siteTitleInput) {
      siteTitleInput.addEventListener('input', () => refreshDeleteSection());
    }
    refreshDeleteSection({ resetInput: true });

    let awsDepsPromise = null;
    function loadAwsDeps() {
      if (!awsDepsPromise) {
        awsDepsPromise = Promise.all([
          import("https://esm.sh/@aws-sdk/client-s3@3.569.0?bundle&target=es2020&conditions=browser"),
          import("https://esm.sh/@aws-sdk/credential-provider-cognito-identity@3.569.0?bundle&target=es2020&conditions=browser")
        ]).then(([s3Module, cognitoModule]) => ({
          S3Client: s3Module.S3Client,
          ListObjectsV2Command: s3Module.ListObjectsV2Command,
          DeleteObjectCommand: s3Module.DeleteObjectCommand,
          fromCognitoIdentityPool: cognitoModule.fromCognitoIdentityPool
        })).catch(err => {
          awsDepsPromise = null;
          throw err;
        });
      }
      return awsDepsPromise;
    }

    async function purgeS3Prefix(s3, bucket, prefix, ListObjectsV2Command, DeleteObjectCommand) {
      if (!prefix) return;
      let continuationToken;
      do {
        const resp = await s3.send(new ListObjectsV2Command({
          Bucket: bucket,
          Prefix: prefix,
          ContinuationToken: continuationToken
        }));
        const keys = (resp.Contents || []).map(obj => obj.Key).filter(Boolean);
        if (keys.length) {
          const chunkSize = 12;
          for (let i = 0; i < keys.length; i += chunkSize) {
            const chunk = keys.slice(i, i + chunkSize);
            await Promise.all(chunk.map(Key => s3.send(new DeleteObjectCommand({ Bucket: bucket, Key }))));
          }
        }
        continuationToken = resp.IsTruncated ? resp.NextContinuationToken : undefined;
      } while (continuationToken);
    }

    async function deleteSiteAssets(config) {
      const { bucket, region, idPool, objectPrefix } = config;
      if (!bucket || !region || !idPool || !objectPrefix) return;
      const basePrefix = objectPrefix.replace(/^\/+/, '');
      const { S3Client, ListObjectsV2Command, DeleteObjectCommand, fromCognitoIdentityPool } = await loadAwsDeps();
      const s3 = new S3Client({
        region,
        credentials: fromCognitoIdentityPool({ identityPoolId: idPool, clientConfig: { region } })
      });

      await purgeS3Prefix(s3, bucket, basePrefix, ListObjectsV2Command, DeleteObjectCommand);
      const streamPrefix = `streams/${basePrefix}`.replace(/\/{2,}/g, '/');
      await purgeS3Prefix(s3, bucket, streamPrefix, ListObjectsV2Command, DeleteObjectCommand);
    }

    async function handleDeleteSite() {
      if (!editingSite || !editingSite.slug) {
        alert('No site is currently loaded to delete.');
        return;
      }
      if (!deleteInput || !deleteButton) return;

      const expected = deleteConfirmPhrase;
      const typed = (deleteInput.value || '').trim();
      if (!expected) {
        alert('Confirmation phrase is not ready yet. Please try again.');
        return;
      }
      if (typed !== expected) {
        alert(`Type "${expected}" exactly to confirm deletion.`);
        return;
      }
      if (!window.confirm('This will permanently delete your site and all associated files. Continue?')) {
        return;
      }

      const user = await waitForUser();
      if (!user) {
        alert('Please sign in first.');
        return;
      }

      deleteButton.disabled = true;
      deleteButton.textContent = 'Deleting...';

      let deletionSucceeded = false;
      try {
        const slug = editingSite.slug;
        const docRef = db.collection('sites').doc(slug);
        const docSnap = await docRef.get();
        if (!docSnap.exists) {
          alert('This site no longer exists.');
          editingSite = null;
          refreshDeleteSection({ resetInput: true });
          await prefillFromAccount();
          deletionSucceeded = true;
          return;
        }

        const data = docSnap.data();
        if ((data.createdBy || '') !== user.uid) {
          alert('You do not have permission to delete this site.');
          return;
        }

        const plan = data.plan || editingSite.plan || 'managed';
        const isManaged = plan === 'managed';
        let bucket = '';
        let region = '';
        let idPool = '';

        if (isManaged) {
          const managed = await managedConfigPromise;
          bucket = managed.BUCKET;
          region = managed.REGION;
          idPool = managed.ID_POOL;
        } else {
          bucket = data.bucket || editingSite.bucket || '';
          region = data.region || editingSite.region || '';
          idPool = data.idPool || editingSite.idPool || '';
        }

        const objectPrefix = ensureTrailingSlash(data.objectPrefix || editingSite.objectPrefix || (isManaged ? `sites/${slug}/` : ''));
        const hasStorageConfig = bucket && region && idPool && objectPrefix;
        if (hasStorageConfig) {
          await deleteSiteAssets({ bucket, region, idPool, objectPrefix });
        } else {
          console.warn('Skipping storage cleanup due to missing configuration', { bucket, region, idPool, objectPrefix });
        }
        await docRef.delete();

        const formEl = document.querySelector('form');
        if (formEl) formEl.reset();
        if (typeof updateColor === 'function') updateColor();
        editingSite = null;
        deletionSucceeded = true;
        if (siteTitleInput) siteTitleInput.value = '';
        refreshDeleteSection({ resetInput: true });
        showSiteNotice('');
        await prefillFromAccount();

        if (siteResult) {
          siteResult.dataset.state = 'success';
          siteResult.textContent = hasStorageConfig
            ? 'Site deleted successfully.'
            : 'Site deleted. Remove any remaining files from storage to complete cleanup.';
          siteResult.style.display = 'block';
          siteResult.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (err) {
        console.error('Failed to delete site', err);
        alert('Could not delete the site. Please try again.');
      } finally {
        deleteButton.disabled = false;
        deleteButton.textContent = 'Delete site permanently';
        if (!deletionSucceeded && deleteInput) deleteInput.focus();
      }
    }

    // Sign-in helper
    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      try {
        if (isMobile) {
          await firebase.auth().signInWithRedirect(provider);
        } else {
          await firebase.auth().signInWithPopup(provider);
        }
      } catch (e) {
        alert('Sign-in failed: ' + (e.message || e));
      }
    }

    function setUserMenu(user) {
      // Always show the userbar (avatar + dropdown)
      userbar.style.display = 'flex';

      // Blank 1×1 transparent PNG for the "blank icon" state
      const BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

      if (user) {
        const nameOrEmail = user.displayName || user.email || 'You';
        avatarEl.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(nameOrEmail)}&background=E5E7EB&color=111827`;
        avatarEl.title = nameOrEmail;

        // Show both "Go to main page" and "Sign out"
        mainBtn.textContent = 'Go to main page';
        mainBtn.onclick = () => { window.location.href = 'https://sharedlens.ca/'; };

        authBtn.textContent = 'Sign out';
        authBtn.onclick = async () => {
          try {
            await firebase.auth().signOut();
            window.location.href = 'https://sharedlens.ca/';
          } catch (e) {
            alert('Sign-out failed: ' + (e.message || e));
          }
        };
      } else {
        // Blank avatar + menu with "Go to main page" and "Sign in"
        avatarEl.src = BLANK;
        avatarEl.title = 'Not signed in';

        mainBtn.textContent = 'Go to main page';
        mainBtn.onclick = () => { window.location.href = 'https://sharedlens.ca/'; };

        authBtn.textContent = 'Sign in';
        authBtn.onclick = () => { signInWithGoogle(); };
      }
    }

    // Toggle dropdown
    avatarEl.addEventListener('click', (e) => {
      e.stopPropagation();
      menuEl.classList.toggle('show');
    });
    document.addEventListener('click', () => menuEl.classList.remove('show'));

    // Keep it in sync with auth state
    firebase.auth().onAuthStateChanged(user => { setUserMenu(user); });

    // Ensure avatar/menu render ASAP on load
    waitForUser().then(setUserMenu);

    const db = firebase.firestore();
    if (deleteButton) {
      deleteButton.addEventListener('click', () => {
        handleDeleteSite();
      });
    }

    // Title: letters/numbers + single spaces (ASCII), no leading/trailing spaces
    const TITLE_RE = /^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$/;
    const RESERVED_SLUGS = new Set(['form', 'home', '404']);

    function toSlug(title) {
      const clean = title.trim().replace(/\s+/g, ' ');
      if (!TITLE_RE.test(clean)) throw new Error('Title may only contain letters, numbers, and single spaces between words.');
      return clean.toLowerCase().replace(/ /g, '-');
    }

    // --- Prefill the form with the requested site (or latest) ---
    async function prefillFromAccount() {
      const user = await waitForUser();
      if (!user) {
        editingSite = null;
        refreshDeleteSection({ resetInput: true });
        return; // not signed in → nothing to prefill
      }

      let docSnap = null;
      editingSite = null;
      refreshDeleteSection({ resetInput: true });

      if (SLUG_PARAM) {
        try {
          const candidate = await db.collection('sites').doc(SLUG_PARAM).get();
          if (!candidate.exists) {
            showSiteNotice(`No site named "${SLUG_PARAM}" was found. Complete the form below to create it.`);
            return;
          }

          const candidateData = candidate.data();
          if ((candidateData.createdBy || '') !== user.uid) {
            showSiteNotice('You do not have permission to edit this site.');
            return;
          }

          docSnap = candidate;
        } catch (err) {
          console.error('Failed to load site from slug parameter', err);
          showSiteNotice('Could not load that site. Please reload and try again.');
          return;
        }
      } else {
        const snap = await db.collection('sites')
          .where('createdBy', '==', user.uid)
          .orderBy('createdAt', 'desc')
          .limit(1)
          .get();

        if (snap.empty) {
          showSiteNotice('');
          return;
        }

        docSnap = snap.docs[0];
      }

      if (!docSnap) return;

      const d = docSnap.data();
      // 1) Title
      if (siteTitleInput) siteTitleInput.value = d.title || '';

      // 2) Primary color → parse "hsl(H S% L%)" and set sliders
      const m = (d.primaryColor || '').match(/hsl\(\s*([\d.]+)\s+([\d.]+)%\s+([\d.]+)%\s*\)/i);
      if (m) {
        document.getElementById('hue').value = +m[1];
        document.getElementById('sat').value = +m[2];
        document.getElementById('light').value = +m[3];
        // your page already defines updateColor()
        if (typeof updateColor === 'function') updateColor();
      }

      // 3) S3 settings
      const plan = d.plan || (d.bucket && d.region && d.idPool ? 'self-managed' : 'managed');
      const fontSelect = document.getElementById('siteFont');
      const storedKey = resolveFontKey(d.fontFamily);
      fontSelect.value = storedKey;

      const slugForEditing = d.slug || docSnap.id;

      const siteUrl = `https://sharedlens.ca/${slugForEditing}`;
      showSiteNotice({
        prefix: 'Editing site: ',
        linkHref: siteUrl,
        linkText: siteUrl,
        buttons: [
          { label: 'View Site', href: siteUrl, variant: 'btn-outline' },
          { label: 'Download QR Code', kind: 'qr-download', slug: slugForEditing, siteUrl, variant: 'btn-outline' }
        ]
      });

      editingSite = {
        slug: slugForEditing,
        plan,
        objectPrefix: ensureTrailingSlash(d.objectPrefix || (plan === 'managed' ? `sites/${slugForEditing}/` : '')),
        bucket: d.bucket || '',
        region: d.region || '',
        idPool: d.idPool || '',
        fontFamily: storedKey,
        title: d.title || ''
      };
      refreshDeleteSection({ resetInput: true });
    }

    // Run prefill as soon as auth resolves (user or null)
    firebase.auth().onAuthStateChanged(() => { prefillFromAccount(); });

    // --- Submit handler: now includes the S3 check ---
    async function submitForm(e) {
      e.preventDefault();
      const btn = e.submitter || document.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;

      try {
        if (siteResult) {
          siteResult.style.display = 'none';
          siteResult.textContent = '';
          siteResult.removeAttribute('data-state');
        }
        const user = await waitForUser();
        if (!user) { alert('Please sign in first.'); return; }

        const titleRaw = siteTitleInput ? siteTitleInput.value || '' : '';
        let slug; try { slug = toSlug(titleRaw); } catch (err) { alert(err.message); return; }

        // Color → HSL string
        const h = document.getElementById('hue').value;
        const s = document.getElementById('sat').value;
        const l = document.getElementById('light').value;
        const primaryColor = `hsl(${h} ${s}% ${l}%)`;

        const fontSelect = document.getElementById('siteFont');
        const fontKeyRaw = (fontSelect.value || '').trim();
        const fontFamilyKey = resolveFontKey(fontKeyRaw);

        const isEditing = !!(editingSite && editingSite.slug);
        const oldSlug = isEditing ? editingSite.slug : null;
        const slugChanged = isEditing && oldSlug !== slug;

        if ((!isEditing || slugChanged) && RESERVED_SLUGS.has(slug)) {
          alert('That title is reserved. Please choose a different site name.');
          return;
        }

        let plan = 'managed';
        let bucket = '';
        let region = '';
        let idPool = '';
        let objectPrefix = '';

        if (isEditing && editingSite.plan === 'self-managed') {
          plan = 'self-managed';
          bucket = editingSite.bucket || '';
          region = editingSite.region || '';
          idPool = editingSite.idPool || '';
          objectPrefix = ensureTrailingSlash(editingSite.objectPrefix || `sites/${oldSlug || slug}`);

          if (!bucket || !region || !idPool) {
            alert('This site was created with a personal S3 bucket. Please contact support to update its credentials.');
            return;
          }
        } else {
          plan = 'managed';
          try {
            const managed = await managedConfigPromise;
            bucket = managed.BUCKET;
            region = managed.REGION;
            idPool = managed.ID_POOL;
          } catch (err) {
            console.error('Managed config load failed', err);
            alert('Managed storage is not configured yet. Please try again later.');
            return;
          }

          if (!bucket || !region || !idPool) {
            alert('Managed storage is not configured yet. Please try again later.');
            return;
          }

          objectPrefix = ensureTrailingSlash(editingSite?.objectPrefix || `sites/${slug}`);
        }

        if (slugChanged) {
          const existing = await db.collection('sites').doc(slug).get();
          if (existing.exists) {
            alert('That title is taken. Try another.');
            return;
          }
        }

        if (plan === 'managed' && objectPrefix) {
          const prefixSnap = await db.collection('sites')
            .where('objectPrefix', '==', objectPrefix)
            .get();
          const conflict = prefixSnap.docs.some(doc => {
            const docId = doc.id;
            if (slugChanged) {
              return docId !== oldSlug;
            }
            return docId !== slug;
          });
          if (conflict) {
            alert('That storage folder is already in use. Please choose a different site title.');
            return;
          }
        }

        const docRef = db.collection('sites').doc(slug);
        const docData = {
          title: titleRaw.trim().replace(/\s+/g, ' '),
          slug,
          primaryColor,
          region,
          idPool,
          bucket,
          objectPrefix,
          plan,
          fontFamily: fontFamilyKey,
          icoImage: "",
          createdBy: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        if (isEditing && slugChanged) {
          await db.runTransaction(async txn => {
            txn.set(docRef, docData);
            txn.delete(db.collection('sites').doc(oldSlug));
          });
        } else {
          await docRef.set(docData, { merge: false });
        }

        editingSite = {
          slug,
          plan,
          objectPrefix,
          bucket,
          region,
          idPool,
          fontFamily: fontFamilyKey,
          title: docData.title
        };
        refreshDeleteSection({ resetInput: true });

        if (siteResult) {
          const url = new URL(`/${slug}`, window.location.origin).toString();
          showSiteNotice({
            state: 'success',
            prefix: 'Your site is ready at ',
            linkHref: url,
            linkText: url,
            buttons: [
              { label: 'View Site', href: url, variant: 'btn-outline' },
              { label: 'Download QR Code', kind: 'qr-download', slug, siteUrl: url, variant: 'btn-outline' }
            ]
          });
          siteResult.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (err) {
        alert(err.code === 'permission-denied'
          ? 'That title is taken. Try another.'
          : 'Could not create site: ' + (err.message || err));
      } finally {
        if (btn) btn.disabled = false;
      }
    }
  </script>

</body>

</html>
