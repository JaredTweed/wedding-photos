<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding Photos Config — Shared Lens</title>
  <meta name="theme-color" content="#000000" />

  <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>

  <!-- Type: elegant serif for wordmark + clean sans for body -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Poppins:wght@400;600&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --ink: #111;
      --paper: #f6f6f6;
      --primary: hsl(96 23.7% 54%);
      /* default to match the sliders' initial values */
      --current-hue: 96;
      --current-sat: 23.7;
      --current-light: 54;
    }

    * {
      box-sizing: border-box;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100svh - 32px);
      padding: 0;

    }

    .card {
      width: 100%;
      max-width: 720px;
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 18px;
      box-shadow: 0 10px 0 #000;
      padding: 2rem clamp(1.25rem, 3vw, 2.5rem);
      text-align: center;
      margin: 8px 8px 16px;
    }

    /* Brand lockup */
    .brand {
      display: grid;
      grid-template-columns: 100%;
      justify-items: center;
      gap: .75rem;
      margin-bottom: .5rem;
    }

    .logo-mark {
      width: 90px;
      height: 90px;
      object-fit: contain;
    }

    .wordmark {
      margin: 0;
      font-family: 'Cormorant Garamond', serif;
      font-weight: 700;
      letter-spacing: 0.18em;
      font-size: clamp(1.4rem, 4.8vw, 2rem);
      text-transform: uppercase;
    }

    .subtitle {
      margin: .25rem 0 0 0;
      font-size: .95rem;
      color: #444;
      font-style: italic;
    }

    /* Divider */
    .rule {
      border: none;
      height: 1px;
      background: #000;
      margin: 1rem auto 1.25rem;
      width: min(620px, 90%);
      opacity: 0.15;
    }

    /* Content text */
    p {
      margin: auto;
      /* max-width: 60ch; */
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-underline-offset: 3px;
    }

    /* Form layout (kept monochrome to match style) */
    form {
      text-align: left;
      margin: 0 auto;
      width: min(640px, 100%);
    }

    .field {
      margin: 1rem 0;
    }

    label {
      display: inline-block;
      font-weight: 600;
      margin-bottom: .35rem;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: .85rem 1rem;
      border-radius: 12px;
      border: 2px solid #000;
      background: #fff;
      font-size: 1rem;
      box-shadow: 0 4px 0 #000;
      outline: none;
      transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease;
    }

    input[type="text"]:focus,
    select:focus {
      transform: translateY(-1px);
    }

    input::placeholder {
      color: #6b7280;
    }

    /* Buttons (identical language to landing page) */
    .button-row {
      display: grid;
      gap: .75rem;
      justify-items: center;
      margin-top: 1.25rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .6rem;
      padding: .85rem 1.4rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 999px;
      border: 2px solid #000;
      cursor: pointer;
      text-decoration: none;
      transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, color .12s ease;
      will-change: transform;
    }

    .btn-fill {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 0 #000;
    }

    .btn-fill:hover {
      transform: translateY(-2px);
      filter: brightness(0.96);
    }

    .btn-fill:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #000;
      filter: brightness(0.9);
    }

    /* Color section (kept clean; only tracks are colorful) */
    .color-card {
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 16px;
      box-shadow: 0 6px 0 #000;
      padding: 1.25rem;
      margin: 1rem 0 0.25rem;
    }

    .color-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: .75rem;
    }

    .color-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: .02em;
    }

    #colorPreviewLarge {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 2px solid #000;
      box-shadow: 0 4px 0 #000;
      background: hsl(var(--current-hue), var(--current-sat), var(--current-light));
    }

    .hsl-readout {
      margin: .5rem 0 1rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: .9rem;
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 10px;
      box-shadow: 0 4px 0 #000;
      padding: .5rem .75rem;
      text-align: center;
    }

    .slider-block {
      margin: .8rem 0 1rem;
    }

    .slider-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: .9rem;
    }

    .slider-value {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      border: 1.5px solid #000;
      border-radius: 8px;
      padding: .2rem .5rem;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 28px;
      border-radius: 8px;
      margin-top: .45rem;
      border: 1.5px solid #000;
      background: #eee;
      box-shadow: 0 3px 0 #000;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 0 2px 0 #000;
    }

    input[type="range"]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 0 2px 0 #000;
    }

    /* Colorful tracks */
    .hue-track {
      background: linear-gradient(to right,
          #ff0000 0%,
          #ffff00 17%,
          #00ff00 33%,
          #00ffff 50%,
          #0000ff 67%,
          #ff00ff 83%,
          #ff0000 100%);
    }

    .sat-track {
      background: linear-gradient(to right,
          hsl(var(--current-hue) 0% 50%) 0%,
          hsl(var(--current-hue) 100% 50%) 100%);
    }

    .light-track {
      background: linear-gradient(to right,
          hsl(var(--current-hue) var(--current-sat) 0%) 0%,
          hsl(var(--current-hue) var(--current-sat) 50%) 50%,
          hsl(var(--current-hue) var(--current-sat) 100%) 100%);
    }

    /* Tiny note */
    .notice {
      font-size: .85rem;
      color: #555;
      opacity: .9;
      text-align: center;
    }

    /* User bar (monochrome) */
    #sl-userbar {
      position: fixed;
      top: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10000;
    }

    #sl-user-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 2px solid #000;
      box-shadow: 0 4px 0 #000;
      cursor: pointer;
      background: #eee;
      object-fit: cover;
    }

    #sl-user-menu {
      position: absolute;
      top: 56px;
      right: 0;
      background: #fff;
      border: 1.5px solid #000;
      border-radius: 12px;
      box-shadow: 0 8px 0 #000;
      padding: 6px;
      min-width: 180px;
      display: none;
    }

    #sl-user-menu.show {
      display: block;
    }

    #sl-user-menu button {
      width: 100%;
      background: none;
      border: 0;
      text-align: left;
      padding: .6rem .8rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    #sl-user-menu button:hover {
      background: #111;
      color: #fff;
    }

    @media (max-width: 640px) {
      .card {
        padding: 1.5rem;
      }

      form {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <!-- User menu -->
  <div id="sl-userbar" style="display:none;">
    <img id="sl-user-avatar" alt="User" />
    <div id="sl-user-menu">
      <button id="sl-logout">Sign out</button>
    </div>
  </div>

  <main class="card">
    <!-- Brand -->
    <div class="brand">
      <img class="logo-mark" src="/assets/shared-lens-logo.png" alt="Shared Lens logo" />
      <h1 class="wordmark">Shared Lens</h1>
      <p class="subtitle">Different perspectives, one story.</p>
    </div>

    <hr class="rule" />

    <!-- Config form -->
    <form onsubmit="submitForm(event)">
      <p style="text-align:center; margin-top:.25rem">
        Configure your wedding photos site. Your settings can be changed later.
      </p>

      <div class="field">
        <label for="siteTitle">Site Title</label>
        <input id="siteTitle" type="text" placeholder="Wedding Photos" />
      </div>

      <div class="color-card" aria-label="Primary color selector">
        <canvas id="hueGradientCanvas" width="360" height="1" style="display:none;"></canvas>

        <div class="color-head">
          <h3 class="color-title">Primary Color</h3>
          <div id="colorPreviewLarge" title="Preview"></div>
        </div>

        <div id="hslValue" class="hsl-readout">hsl(96 23.7% 54%)</div>

        <div class="slider-block">
          <div class="slider-label">
            <span>Hue</span><span class="slider-value" id="hueValue">96°</span>
          </div>
          <input id="hue" class="hue-track hue" type="range" min="0" max="360" step="1" value="96"
            oninput="updateColor()" />
        </div>

        <div class="slider-block">
          <div class="slider-label">
            <span>Saturation</span><span class="slider-value" id="satValue">23.7%</span>
          </div>
          <input id="sat" class="sat-track" type="range" min="0" max="100" step="0.1" value="23.7"
            oninput="updateColor()" />
        </div>

        <div class="slider-block">
          <div class="slider-label">
            <span>Lightness</span><span class="slider-value" id="lightValue">54%</span>
          </div>
          <input id="light" class="light-track" type="range" min="0" max="100" step="0.1" value="54"
            oninput="updateColor()" />
        </div>
      </div>

      <div class="field">
        <label for="useS3">Use Your Own S3 Bucket?</label>
        <select id="useS3" onchange="toggleS3Fields()">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>

      <div id="s3Fields" style="display:none;">
        <div class="field" style="margin-top:.5rem;">
          <button class="btn" type="button" onclick="toggleInfoBox()">How do I get this info?</button>
        </div>

        <div class="field">
          <label for="bucketName">Bucket Title</label>
          <input id="bucketName" type="text" placeholder="my-bucket-title" />
        </div>

        <div class="field">
          <label for="bucketRegion">Bucket Region</label>
          <input id="bucketRegion" type="text" placeholder="ca-central-1" />
        </div>

        <div class="field">
          <label for="idPool">Cognito Identity Pool ID</label>
          <input id="idPool" type="text" placeholder="ca-central-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
        </div>

        <div id="s3Instructions" style="display:none; margin-top:.5rem;">
          <div class="color-card" style="box-shadow:none;">
            <p style="margin-top:0"><strong>Step 1:</strong> Create an S3 bucket and replace
              <code>my-bucket-title</code> accordingly.
            </p>
            <p><strong>Bucket Policy:</strong></p>
            <pre
              style="text-align:left; white-space:pre-wrap; word-break:break-word; border:1px solid #000; border-radius:10px; padding:.75rem; box-shadow:0 3px 0 #000; background:#fff;">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowPublicRead",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-bucket-title/*"
    }
  ]
}</pre>

            <p><strong>CORS Configuration:</strong></p>
            <pre
              style="text-align:left; white-space:pre-wrap; word-break:break-word; border:1px solid #000; border-radius:10px; padding:.75rem; box-shadow:0 3px 0 #000; background:#fff;">[
  {
    "AllowedHeaders": ["*"],
    "AllowedMethods": ["GET","PUT","POST","DELETE","HEAD"],
    "AllowedOrigins": ["*","null"],
    "ExposeHeaders": ["ETag","x-amz-request-id","x-amz-meta-description","x-amz-meta-otherkey"],
    "MaxAgeSeconds": 1800
  }
]</pre>

            <p><strong>Step 2:</strong> Create a role with permissions.</p>
            <pre
              style="text-align:left; white-space:pre-wrap; word-break:break-word; border:1px solid #000; border-radius:10px; padding:.75rem; box-shadow:0 3px 0 #000; background:#fff;">{
  "Version": "2012-10-17",
  "Statement": [
    { "Effect": "Allow", "Action": "s3:ListBucket", "Resource": "arn:aws:s3:::my-bucket-title" },
    { "Effect": "Allow", "Action": ["s3:GetObject","s3:PutObject","s3:DeleteObject"], "Resource": "arn:aws:s3:::my-bucket-title/*" }
  ]
}</pre>

            <p><strong>Step 3:</strong> Create a Cognito Identity Pool and enable guest access using the role from Step
              2.</p>
          </div>
        </div>
      </div>

      <div id="notAvailable" class="notice" style="display:none; margin-top:1rem;">
        S3 integration is not available yet unless using your own bucket.
      </div>

      <div class="button-row">
        <button type="submit" class="btn btn-fill">Submit</button>
      </div>
    </form>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOcPjy9OsoWDuykf0XuvKfB9sAxSRvC7A",
      authDomain: "sharedlens.ca",
      projectId: "wedding-login-32785",
      storageBucket: "wedding-login-32785.firebasestorage.app",
      messagingSenderId: "554454604780",
      appId: "1:554454604780:web:d7dfe10583f26d13cc7ec9",
      measurementId: "G-J9BEKPXHYF"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    /* --- dynamic HSL handling --- */
    function hsl() {
      const h = document.getElementById('hue').value;
      const s = document.getElementById('sat').value;
      const l = document.getElementById('light').value;
      return `hsl(${h} ${s}% ${l}%)`;
    }

    function updateColor() {
      const h = document.getElementById('hue').value;
      const s = document.getElementById('sat').value;
      const l = document.getElementById('light').value;
      const color = `hsl(${h} ${s}% ${l}%)`;

      // Update CSS custom properties
      document.documentElement.style.setProperty('--primary', color);
      document.documentElement.style.setProperty('--current-hue', h);
      document.documentElement.style.setProperty('--current-sat', s);

      // Update displays
      document.getElementById('hslValue').textContent = color;
      document.getElementById('colorPreviewLarge').style.background = color;

      // Update individual value displays
      document.getElementById('hueValue').textContent = h + '°';
      document.getElementById('satValue').textContent = s + '%';
      document.getElementById('lightValue').textContent = l + '%';

      // Update slider backgrounds for saturation and lightness
      const satSlider = document.getElementById('sat');
      const lightSlider = document.getElementById('light');

      satSlider.style.background = `linear-gradient(to right, 
        hsl(${h}, 0%, 50%) 0%, 
        hsl(${h}, 100%, 50%) 100%)`;

      lightSlider.style.background = `linear-gradient(to right, 
        hsl(${h}, ${s}%, 0%) 0%, 
        hsl(${h}, ${s}%, 50%) 50%, 
        hsl(${h}, ${s}%, 100%) 100%)`;
    }

    // Initialize color display
    updateColor();

    /* --- S3 toggle & info box --- */
    function toggleS3Fields() {
      const useS3 = document.getElementById('useS3').value === 'yes';
      document.getElementById('s3Fields').style.display = useS3 ? 'block' : 'none';
      document.getElementById('notAvailable').style.display = useS3 ? 'none' : 'block';
    }
    function toggleInfoBox() {
      const box = document.getElementById('s3Instructions');
      box.style.display = box.style.display === 'block' ? 'none' : 'block';
    }




    function generatePerfectHueGradient() {
      const canvas = document.getElementById('hueGradientCanvas');
      const ctx = canvas.getContext('2d');
      const width = canvas.width;

      for (let x = 0; x < width; x++) {
        ctx.fillStyle = `hsl(${x}, 100%, 50%)`;
        ctx.fillRect(x, 0, 1, 1);
      }

      const dataURL = canvas.toDataURL();
      document.querySelector('.hue').style.backgroundImage = `url(${dataURL})`;
      document.querySelector('.hue').style.backgroundSize = '100% 100%';
    }

    generatePerfectHueGradient();

  </script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    // --- Auth readiness helper (fixes the "first submit says not signed in") ---
    // Tiny helper to wait for a definitive auth state
    function waitForUser() {
      const u = firebase.auth().currentUser;
      if (u) return Promise.resolve(u);
      return new Promise(resolve => {
        const off = firebase.auth().onAuthStateChanged(user => { off(); resolve(user || null); });
      });
    }

    const userbar = document.getElementById('sl-userbar');
    const avatarEl = document.getElementById('sl-user-avatar');
    const menuEl = document.getElementById('sl-user-menu');
    const logoutBtn = document.getElementById('sl-logout');

    function setUserMenu(user) {
      // Avatar image + tooltip
      userbar.style.display = user ? 'flex' : 'none';
      const fallback = (txt) => `https://ui-avatars.com/api/?name=${encodeURIComponent(txt)}&background=E5E7EB&color=111827`;
      const nameOrEmail = user?.displayName || user?.email || 'You';
      avatarEl.src = user?.photoURL || fallback(nameOrEmail);
      avatarEl.title = user ? `${nameOrEmail}` : 'Not signed in';

      // If not signed in, clicking avatar returns to home
      if (!user) {
        logoutBtn.textContent = 'Go to main page';
        logoutBtn.onclick = () => { window.location.href = 'https://sharedlens.ca/'; };
      } else {
        logoutBtn.textContent = 'Sign out';
        logoutBtn.onclick = async () => {
          try {
            await firebase.auth().signOut();
            window.location.href = 'https://sharedlens.ca/';
          } catch (e) {
            alert('Sign-out failed: ' + (e.message || e));
          }
        };
      }
    }

    // Toggle dropdown
    avatarEl.addEventListener('click', (e) => {
      e.stopPropagation();
      menuEl.classList.toggle('show');
    });
    document.addEventListener('click', () => menuEl.classList.remove('show'));

    // Keep it in sync with auth state
    firebase.auth().onAuthStateChanged(user => {
      setUserMenu(user);
    });

    // If the page loads with a cached user, this ensures the avatar appears immediately
    waitForUser().then(setUserMenu);

    const db = firebase.firestore();

    // Title: letters/numbers + single spaces (ASCII), no leading/trailing spaces
    const TITLE_RE = /^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$/;

    function toSlug(title) {
      const clean = title.trim().replace(/\s+/g, ' ');
      if (!TITLE_RE.test(clean)) throw new Error('Title may only contain letters, numbers, and single spaces between words.');
      return clean.toLowerCase().replace(/ /g, '-');
    }

    // --- Prefill the form with your latest site (if you’ve created one before) ---
    async function prefillFromAccount() {
      const user = await waitForUser();
      if (!user) return; // not signed in → nothing to prefill

      const snap = await db.collection('sites')
        .where('createdBy', '==', user.uid)
        .orderBy('createdAt', 'desc')
        .limit(1)
        .get();

      if (snap.empty) return;

      const d = snap.docs[0].data();
      // 1) Title
      const titleEl = document.getElementById('siteTitle');  // exists in your form
      titleEl.value = d.title || '';

      // 2) Primary color → parse "hsl(H S% L%)" and set sliders
      const m = (d.primaryColor || '').match(/hsl\(\s*([\d.]+)\s+([\d.]+)%\s+([\d.]+)%\s*\)/i);
      if (m) {
        document.getElementById('hue').value = +m[1];
        document.getElementById('sat').value = +m[2];
        document.getElementById('light').value = +m[3];
        // your page already defines updateColor()
        if (typeof updateColor === 'function') updateColor();
      }

      // 3) S3 settings
      const hasS3 = !!(d.bucket && d.region && d.idPool);
      document.getElementById('useS3').value = hasS3 ? 'yes' : 'no';
      document.getElementById('bucketName').value = d.bucket || '';
      document.getElementById('bucketRegion').value = d.region || '';
      document.getElementById('idPool').value = d.idPool || '';
      if (typeof toggleS3Fields === 'function') toggleS3Fields();
    }

    // Run prefill as soon as auth resolves (user or null)
    firebase.auth().onAuthStateChanged(() => { prefillFromAccount(); });

    // Reflect whatever the HTML default is on first paint
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof toggleS3Fields === 'function') toggleS3Fields();
    });


    // --- S3 bucket health check (list → put → public head → delete) ---
    async function s3HealthCheck({ region, idPool, bucket }) {
      // Dynamic import keeps your form a classic script; no bundler needed
      const s3lib = await import("https://esm.sh/@aws-sdk/client-s3@3.569.0?bundle&target=es2020&conditions=browser");
      const idlib = await import("https://esm.sh/@aws-sdk/credential-provider-cognito-identity@3.569.0?bundle&target=es2020&conditions=browser");

      const { S3Client, ListObjectsV2Command, PutObjectCommand, DeleteObjectCommand } = s3lib;
      const { fromCognitoIdentityPool } = idlib;

      const s3 = new S3Client({
        region,
        credentials: fromCognitoIdentityPool({ identityPoolId: idPool, clientConfig: { region } })
      });

      const key = `__healthcheck__/${Date.now()}_${Math.random().toString(36).slice(2)}.txt`;
      let putOk = false;

      try {
        // 1) Bucket exists & List allowed
        await s3.send(new ListObjectsV2Command({ Bucket: bucket, MaxKeys: 0 }));

        // 2) Can upload
        await s3.send(new PutObjectCommand({
          Bucket: bucket,
          Key: key,
          Body: new Blob(['ok'], { type: 'text/plain' }),
          ContentType: 'text/plain'
        }));
        putOk = true;

        // 3) Object publicly readable (matches how home.html fetches via HTTPS URL)
        const headUrl = `https://${bucket}.s3.${region}.amazonaws.com/${encodeURIComponent(key)}`;
        const resp = await fetch(headUrl, { method: 'HEAD' });
        if (!resp.ok) throw new Error(`Public read failed (HTTP ${resp.status}) — check your bucket policy & CORS.`);

        return { ok: true };
      } catch (err) {
        return { ok: false, message: err.message || String(err) };
      } finally {
        // 4) Clean up if we managed to PUT
        if (putOk) {
          try { await s3.send(new DeleteObjectCommand({ Bucket: bucket, Key: key })); } catch { }
        }
      }
    }

    // --- Submit handler: now includes the S3 check ---
    async function submitForm(e) {
      e.preventDefault();
      const btn = e.submitter || document.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;

      try {
        const user = await waitForUser();
        if (!user) { alert('Please sign in first.'); return; }

        const titleRaw = document.getElementById('siteTitle').value || '';
        let slug; try { slug = toSlug(titleRaw); } catch (err) { alert(err.message); return; }

        // Color → HSL string
        const h = document.getElementById('hue').value;
        const s = document.getElementById('sat').value;
        const l = document.getElementById('light').value;
        const primaryColor = `hsl(${h} ${s}% ${l}%)`;

        // S3 fields
        const useS3 = document.getElementById('useS3').value === 'yes';
        const bucket = useS3 ? (document.getElementById('bucketName').value || '') : '';
        const region = useS3 ? (document.getElementById('bucketRegion').value || '') : '';
        const idPool = useS3 ? (document.getElementById('idPool').value || '') : '';

        // If using S3, verify access before writing Firestore
        if (useS3) {
          const result = await s3HealthCheck({ region, idPool, bucket });
          if (!result.ok) {
            alert('S3 check failed: ' + result.message + '\n\nPlease fix the bucket policy/CORS/role permissions and try again.');
            return;
          }
        }

        // Create the Firestore doc (ID = slug; uniqueness is enforced by rules)
        const docRef = db.collection('sites').doc(slug);
        await docRef.set({
          title: titleRaw.trim().replace(/\s+/g, ' '),
          slug,
          primaryColor,
          region, idPool, bucket,
          icoImage: "",
          createdBy: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: false });

        // Go to /<slug> (Hosting rewrites serve home.html there)
        window.location.href = `/${slug}`;
      } catch (err) {
        alert(err.code === 'permission-denied'
          ? 'That title is taken. Try another.'
          : 'Could not create site: ' + (err.message || err));
      } finally {
        if (btn) btn.disabled = false;
      }
    }
  </script>

</body>

</html>